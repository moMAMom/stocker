# 技術ロードマップ・アーキテクチャ設計

## 1. 要件分析の確認と技術判断

`Do/01_Requirements.md`の要件から以下の技術的判断を行います：

- **アーキテクチャタイプ：** Web ベースのシンプルなレイヤード・モノリスアーキテクチャ
- **対応市場：** 日本株を主軸（将来的には国際株への拡張を想定）
- **判断ロジック：** テクニカル指標（移動平均線、RSI、MACD など）をベースとした確定的なロジック
- **データ更新：** 手動更新（ユーザーが UI からボタンをクリックして更新）
- **ユーザー認証：** シングルユーザーまたは簡易認証（初期版は不要）

---

## 2. 技術スタック選定

### フロントエンド

- **フレームワーク：** React 18.x（理由：コンポーネント再利用性が高く、ダッシュボード表示に適している）
- **言語：** TypeScript（理由：型安全性により複雑なデータ構造を安全に扱える）
- **UI ライブラリ：** Material-UI v5 または Tailwind CSS（理由：ダッシュボード・テーブル表示に豊富なコンポーネント）
- **チャート表示：** Chart.js + react-chartjs-2 または Recharts（理由：軽量で React 統合が容易）
- **HTTP クライアント：** Axios または Fetch API（理由：バックエンド API との通信）
- **状態管理：** Redux Toolkit（理由：複数銘柄のデータ管理に適している）

### バックエンド

- **フレームワーク：** Node.js + Express.js 4.x（理由：JavaScript/TypeScript で統一でき、開発効率が高い）
- **言語：** TypeScript（理由：フロントエンドとの型共有が可能）
- **データベース：** PostgreSQL 15.x（理由：リレーショナルデータ構造に適し、ACID 特性を備える）
  - 代替案：SQLite（ローカル実行型の場合）
- **API データ取得：** Python スクリプト + Node.js スケジューラ（理由：複雑な計算処理は Python が適しており、スケジューリングは Node.js で管理）
- **ORM：** Prisma または TypeORM（理由：TypeScript との相性が良く、マイグレーション管理が容易）
- **非同期処理：** 手動更新のため不要（将来的なスケジューラー導入時に検討）

### データ取得・テクニカル分析

- **言語：** Python 3.11+（理由：データ分析ライブラリが豊富）
- **データ取得：** yfinance（Yahoo Finance API）✅ 確定（理由：無料で株価データを取得可能）
- **テクニカル分析：** ta-lib または pandas-ta（理由：テクニカル指標の計算に最適化されている）
- **連携方式：** REST API（理由：疎結合で スケーラビリティを確保）

### インフラ・デプロイ

- **開発環境：** Docker + Docker Compose（理由：ローカル環境の再現性を確保）
- **デプロイ先（初期版）：** ローカルサーバー（Docker）
- **デプロイ先（将来）：** Vercel（フロントエンド）+ Heroku/AWS（バックエンド）
- **CI/CD：** GitHub Actions（理由：Git リポジトリとの統合が容易）

---

## 3. 推奨フレームワーク・ライブラリ バージョン

**知識カットオフ時点での推奨版：**

- React: 18.x（最新安定版）
- TypeScript: 5.x
- Express.js: 4.18.x
- PostgreSQL: 15.x
- Prisma: 5.x
- Node.js: 18 LTS または 20 LTS

**重要：** 開発開始時に最新版および互換性を確認してください。

---

## 4. 高レベルアーキテクチャ設計

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザーブラウザ                           │
│                   (React + TypeScript App)                  │
│  [銘柄リスト] [ダッシュボード] [フィルタ・ソート] [ポートフォリオ]  │
└─────────────────────────────┬───────────────────────────────┘
                              │ HTTP/REST
┌─────────────────────────────▼───────────────────────────────┐
│                    Express.js API サーバー                    │
│              (TypeScript + Node.js)                          │
│ [ルーティング] [ビジネスロジック] [認証・認可] [エラーハンドリング] │
└─────────────────────────────┬───────────────────────────────┘
                      ┌───────┴───────┐
                      │               │
                      ▼               ▼
        ┌──────────────────────┐ ┌──────────────────┐
        │  PostgreSQL Database │ │  Python Service  │
        │  (銘柄・データ管理)   │ │(テク指標計算)     │
        │ [銘柄 Master] [分析] │ │ [yfinance] [ta]  │
        └──────────────────────┘ └──────────────────┘
                                       ▲
                                       │
                                 [外部 API]
                               (Yahoo Finance)
```

**アーキテクチャの説明：**

1. フロントエンド（React）：ユーザーインターフェース、銘柄表示、フィルタリング
2. バックエンド API（Express.js）：銘柄データ取得、分析結果提供、ユーザー要求の処理
3. PostgreSQL DB：銘柄マスタ、分析結果キャッシュ、ユーザーデータ
4. Python Service：定期的にテクニカル指標を計算し、結果を DB に保存

---

## 5. モジュール・責務の特定

### モジュール 1：フロントエンド UI

- **責務：** ユーザー入力の受け取り、データ表示、リアルタイムフィルタリング
- **主要コンポーネント：**
  - `StockListTable`：銘柄テーブル表示
  - `DashboardView`：分析結果ダッシュボード
  - `FilterPanel`：絞り込みパネル
  - `ChartComponent`：テクニカル指標チャート

### モジュール 2：バックエンド API

- **責務：** ビジネスロジック実装、DB アクセス、データ加工
- **主要エンドポイント：**
  - `GET /api/stocks` - 銘柄一覧取得（フィルタ対応）
  - `GET /api/stocks/:id` - 銘柄詳細取得
  - `POST /api/stocks` - 銘柄追加
  - `GET /api/analysis/:id` - 分析結果取得

### モジュール 3：データベース層

- **責務：** データの永続化、スキーマ管理
- **主要テーブル：**
  - `stocks` - 銘柄マスタ
  - `analysis_results` - 分析結果（買い/売り判断、スコア）
  - `technical_indicators` - テクニカル指標キャッシュ
  - `portfolio` - ユーザーのポートフォリオ

### モジュール 4：テクニカル分析エンジン

- **責務：** テクニカル指標計算、買い/売り判断ロジック
- **実装方式：** Python スクリプト（定期実行、スケジューラ経由）
- **主要処理：**
  - 移動平均線（MA）計算
  - RSI、MACD 計算
  - ゴールデンクロス・デッドクロス判定
  - 買い/売りスコア算出

### モジュール 5：外部データ取得層

- **責務：** Yahoo Finance などからの株価データ取得
- **実装：** Python の yfinance ライブラリを使用

---

## 6. モジュール間通信・データフロー

### 主要オペレーション 1：銘柄一覧表示

```
ユーザー（フロントエンド）
    ↓ [GET /api/stocks]
Express.js API
    ↓ [Prisma.stocks.findMany()]
PostgreSQL
    ↓ [stocks テーブルデータ]
Express.js API
    ↓ [JSON レスポンス]
フロントエンド（React）
    ↓ [DashboardView に表示]
ユーザー画面
```

### 主要オペレーション 2：分析結果の取得と表示

```
ユーザー（フロントエンド） [銘柄をクリック]
    ↓ [GET /api/analysis/:id]
Express.js API
    ↓ [テクニカル指標キャッシュ取得]
PostgreSQL
    ↓ [analysis_results テーブル]
Express.js API
    ↓ [分析結果 + チャートデータ返却]
フロントエンド（React）
    ↓ [ChartComponent、買い/売り判定表示]
ユーザー画面
```

### ユーザーによる手動更新フロー

```
ユーザー [UI の「分析実行」ボタンをクリック]
    ↓ [POST /api/analyze リクエスト]
Express.js API
    ↓ [Python テクニカル分析スクリプト呼び出し]
Python Service
    ↓ [yfinance で最新株価取得]
Yahoo Finance API
    ↓ [テクニカル指標計算]
Python Service
    ↓ [REST API で Express.js に結果送信]
Express.js API
    ↓ [Prisma で PostgreSQL に保存]
PostgreSQL
    ↓ [フロントエンドに結果返却]
ユーザー画面に分析結果を表示
```

---

## 7. 開発ロードマップ・フェーズ分割

### **フェーズ 1：環境構築と基盤実装 （1-2 週間）**

**目的：** 開発基盤の構築、DB スキーマ設計・実装

**タスク：**

- [ ] プロジェクトリポジトリ初期化（Git + GitHub）
- [ ] Docker + Docker Compose セットアップ
- [ ] Node.js + Express.js プロジェクト初期化
- [ ] TypeScript 設定
- [ ] PostgreSQL スキーマ設計・作成（Prisma スキーマ定義）
- [ ] Prisma マイグレーション実行
- [ ] React プロジェクト初期化（Vite または Create React App）
- [ ] TypeScript 設定（フロントエンド）

**成果物：** 開発環境、DB スキーマ、プロジェクト構造

---

### **フェーズ 2：バックエンド API 実装 （2-3 週間）**

**目的：** REST API の実装、ビジネスロジック構築

**タスク：**

- [ ] 銘柄管理 API エンドポイント実装（CRUD）
- [ ] 分析結果管理 API 実装
- [ ] フィルタリング・ソート ロジック実装
- [ ] エラーハンドリング・バリデーション実装
- [ ] API テスト作成（Jest + Supertest）
- [ ] API ドキュメント作成（Swagger/OpenAPI）

**依存関係：** フェーズ 1 完了後

**成果物：** 動作する REST API、テストケース

---

### **フェーズ 3：テクニカル分析エンジン実装 （1-2 週間）**

**目的：** テクニカル指標計算、買い/売り判断ロジック

**タスク：**

- [ ] Python 環境構築（pyenv + venv）
- [ ] yfinance 統合実装
- [ ] テクニカル指標計算関数実装（MA、RSI、MACD など）
- [ ] 買い/売り判定ロジック実装
- [ ] 手動更新用 API エンドポイント実装（/api/analyze）
- [ ] Python スクリプトのテスト

**依存関係：** フェーズ 1、2 の部分完了後

**成果物：** 動作するテクニカル分析エンジン

---

### **フェーズ 4：フロントエンド UI 実装 （2-3 週間）**

**目的：** ユーザーインターフェース構築

**タスク：**

- [ ] レイアウト・ナビゲーション実装
- [ ] 銘柄リスト表示・管理画面
- [ ] ダッシュボード画面実装
- [ ] フィルタリング UI 実装
- [ ] チャート表示コンポーネント実装
- [ ] ポートフォリオ追跡画面実装
- [ ] 状態管理（Redux）セットアップ
- [ ] API 連携テスト

**依存関係：** フェーズ 2 完了後

**成果物：** 完成した UI、API との連携確認

---

### **フェーズ 5：統合テスト・最適化・デプロイ （1-2 週間）**

**目的：** 全体統合、性能最適化、本番デプロイ

**タスク：**

- [ ] E2E テスト実装（Cypress または Playwright）
- [ ] パフォーマンス最適化（API レスポンス時間、フロントエンド レンダリング）
- [ ] セキュリティチェック（OWASP Top 10）
- [ ] ドキュメント完成（ユーザーガイド、開発ガイド）
- [ ] デプロイメント準備（環境変数設定、ビルド自動化）
- [ ] CI/CD パイプライン設定（GitHub Actions）
- [ ] 本番環境へのデプロイ
- [ ] 運用モニタリング設定

**依存関係：** フェーズ 1-4 完了

**成果物：** 本番環境で動作するアプリケーション

---

## 8. 技術選定の理由と トレードオフ

### React 採用理由

- ✅ コンポーネント再利用性が高い（複数銘柄のダッシュボード表示に最適）
- ✅ 豊富なライブラリエコシステム
- ❌ バンドルサイズが大きい（初期ロード時間）→ 対策：コード分割、遅延読み込み

### Express.js 採用理由

- ✅ JavaScript/TypeScript で統一でき、開発効率が高い
- ✅ 軽量で高速
- ❌ エンタープライズ機能が限定的 → 必要に応じて Nest.js への移行も検討

### PostgreSQL 採用理由

- ✅ ACID トランザクション保証
- ✅ JSON データ型でノンリレーショナル データも扱える
- ❌ スケールアップが複雑 → 初期版ではシングルサーバーで対応

### Python でのテクニカル分析採用理由

- ✅ ta-lib などの豊富なライブラリ
- ✅ 計算処理が高速
- ❌ Node.js との言語の混在 → REST API で疎結合に保ち、言語依存を最小化

---

## 9. 重要な技術的検討事項

### 1. 自動更新 vs 手動更新

**現在の判断：** 初期版は手動更新（ユーザーが UI からボタンをクリック）
**将来拡張：** 自動スケジューリング機能（node-cron による定期更新）の導入

### 2. テクニカル指標の精度向上

**候補 1：** 複数指標の重み付け平均（ロジックベース）
**候補 2：** 機械学習モデル（過去データでの学習）
→ 初期版はロジックベース、将来的に機械学習への移行を検討

### 3. スケーラビリティ

**初期版：** シングルサーバー構成
**将来拡張：** マイクロサービスアーキテクチャへの移行、水平スケーリング

### 4. セキュリティ

**重要対策：**

- API 認証・認可（JWT トークン）
- HTTPS 通信の強制
- SQL インジェクション対策（Prisma で自動対応）
- CORS 設定の厳格化

---

## 10. ユーザーへの問いかけ・意思決定点

以下の点についてユーザーの意思決定・フィードバックをお願いします：

1. **対応市場について**
   - 初期版は日本株のみで良いか？
   - 将来的に国際株（アメリカ株など）への対応予定はあるか？

2. **テクニカル指標の選択**
   - どの指標を重視したいか？（移動平均線、RSI、MACD、ボリンジャーバンド など）
   - 複数指標を組み合わせたロジックか、シンプルな単一指標か？

3. **買い/売り判定の信頼度**
   - 判定結果に「信頼度スコア」（例：0-100%）を付与したいか？

4. **データ更新の頻度**
   - 日次更新で十分か、それとも日中複数回の更新が必要か？

5. **デプロイ先の希望**
   - ローカルサーバー上での実行か、クラウドサービス（AWS、Heroku など）か？

6. **マルチユーザー対応**
   - シングルユーザーツール（ローカル実行）でよいか、それとも複数ユーザーが共有するサーバー型か？

---

## 11. 次のステップ

このロードマップに基づき、以下の文書を順序立てて作成します：

1. ✅ `Do/01_Requirements.md` - 要件分析（完了）
2. ✅ `Do/02_Tech_Roadmap.md` - 技術ロードマップ（このドキュメント）
3. ⏳ `Do/03_Tech_datasheet.md` - 技術仕様書
4. ⏳ `Do/04_Tasks.md` - 詳細タスク分解
5. ⏳ `Do/05_Integrity_Report.md` - 設計整合性レポート

ユーザーからの承認と意思決定を受けた後、実装フェーズに移行します。
