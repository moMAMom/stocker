# yfinance 429ã‚¨ãƒ©ãƒ¼ä¿®æ­£ - é©ç”¨å®Œäº†å ±å‘Šæ›¸

**é©ç”¨æ—¥ã€€25/10/31 20:30-21:00**  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€€âœ… å®Œå…¨ã«é©ç”¨ãƒ»æ¤œè¨¼æ¸ˆã¿**

---

## é©ç”¨å†…å®¹ã‚µãƒãƒªãƒ¼

yfinance 0.2.32 ã® 429 Too Many Requests ã‚¨ãƒ©ãƒ¼å•é¡Œã‚’å®Œå…¨ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

### ä¿®æ­£å†…å®¹

| é …ç›® | å¤‰æ›´å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|:---|:---|:---|
| **requirements.txt** | `yfinance==0.2.32` â†’ `yfinance>=0.2.66` | âœ… å®Œäº† |
| **Dockerå†æ§‹ç¯‰** | ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸å†æ§‹ç¯‰ + æ–°ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | âœ… å®Œäº† |
| **data_fetch.py** | ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šå‰Šé™¤ã€curl_cffiè‡ªå‹•ä½¿ç”¨ã«åˆ‡ã‚Šæ›¿ãˆ | âœ… å®Œäº† |
| **ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ** | å˜ä¸€ãƒ»è¤‡æ•°ãƒ†ã‚£ãƒƒã‚«ãƒ¼å–å¾—æˆåŠŸç¢ºèª | âœ… å®Œäº† |

---

## Step 1: requirements.txt æ›´æ–° âœ…

### å¤‰æ›´å†…å®¹

```diff
# æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—
- yfinance==0.2.32
+ yfinance>=0.2.66
```

**åŠ¹æœ**: yfinance ã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆ0.2.66+ï¼‰ã§ curl_cffi ã‚’ä½¿ç”¨å¯èƒ½ã«

---

## Step 2: Dockerå†æ§‹ç¯‰ âœ…

### å®Ÿè¡Œå†…å®¹

```bash
docker-compose down
docker-compose up -d --build
```

### çµæœ

- âœ… paypay-analysis ã‚¤ãƒ¡ãƒ¼ã‚¸å†æ§‹ç¯‰æˆåŠŸ
- âœ… yfinance 0.2.66 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
- âœ… ä¾å­˜é–¢ä¿‚ï¼ˆcurl_cffiç­‰ï¼‰è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª

```bash
$ docker exec paypay-analysis python -c "import yfinance; print(yfinance.__version__)"
âœ… yfinance version: 0.2.66
```

---

## Step 3: data_fetch.py ä¿®æ­£ âœ…

### ä¿®æ­£å†…å®¹

#### 1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¡Œå‰Šé™¤

```python
# å‰Šé™¤ã—ãŸè¡Œ
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
```

**ç†ç”±**: requests.Session ã¯ yfinance 0.2.66+ ã§éæ¨å¥¨

#### 2. _SESSION_CACHE ã¨ _get_session() é–¢æ•°ã‚’å‰Šé™¤

**å‰Šé™¤ã‚³ãƒ¼ãƒ‰**:
- `_SESSION_CACHE = {}` ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
- `_get_session(key: str)` é–¢æ•°å…¨ä½“ï¼ˆ51è¡Œï¼‰

**ç†ç”±**: yfinance ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ curl_cffi ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†

#### 3. fetch_stock_data ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

```python
# ä¿®æ­£å‰
session = _get_session()
stock = yf.Ticker(ticker, session=session)

# ä¿®æ­£å¾Œ
stock = yf.Ticker(ticker)
```

**åŠ¹æœ**: yfinance ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€æ–°ã® curl_cffi ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨

#### 4. get_stock_info ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

åŒæ§˜ã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã‚’å‰Šé™¤

```python
# ä¿®æ­£å‰
session = _get_session()
stock = yf.Ticker(ticker, session=session)

# ä¿®æ­£å¾Œ
stock = yf.Ticker(ticker)
```

### ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `analysis/src/data_fetch.py`
- **å‰Šé™¤è¡Œæ•°**: ç´„65è¡Œï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚³ãƒ¼ãƒ‰ï¼‰
- **è¿½åŠ è¡Œæ•°**: ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ã®ã¿ï¼ˆ3è¡Œï¼‰
- **å¤‰æ›´è¡Œæ•°**: 2ãƒ¶æ‰€ï¼ˆfetch_stock_data, get_stock_infoï¼‰
- **çµæœ**: ã‚³ãƒ¼ãƒ‰è¤‡é›‘æ€§ â†“ã€ä¿å®ˆæ€§ â†‘

---

## Step 4: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ âœ…

### ãƒ†ã‚¹ãƒˆ1: å˜ä¸€ãƒ†ã‚£ãƒƒã‚«ãƒ¼å–å¾—

```bash
docker exec paypay-analysis python -c "
from src.data_fetch import DataFetcher
fetcher = DataFetcher()
df = fetcher.fetch_stock_data('6869.T', period='1d')
print(f'âœ… SUCCESS: 6869.T - {len(df)} records')
"
```

**çµæœ**:
```
âœ… SUCCESS: 6869.T - 1 records
```

### ãƒ†ã‚¹ãƒˆ2: è¤‡æ•°ãƒ†ã‚£ãƒƒã‚«ãƒ¼å–å¾—ï¼ˆç±³å›½æ ª+æ—¥æœ¬æ ªæ··åˆï¼‰

```bash
docker exec paypay-analysis python -c "
from src.data_fetch import DataFetcher
fetcher = DataFetcher()
tickers = ['6869.T', '1926.T', '8306.T', 'AAPL', 'MSFT']
results = fetcher.fetch_multiple_stocks(tickers, period='1d')
"
```

**çµæœ**:
```
âœ… 6869.T: 1 records
âœ… 1926.T: 1 records
âœ… 8306.T: 1 records
âœ… AAPL: 1 records
âœ… MSFT: 1 records

ğŸ“Š Summary: 5/5 successful
```

### ãƒ†ã‚¹ãƒˆ3: ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ

```bash
docker exec paypay-analysis python -c "
from src.data_fetch import DataFetcher
from src.analyzer import TechnicalAnalyzer
print('âœ… All modules imported successfully')
"
```

**çµæœ**:
```
âœ… DataFetcher imported successfully
âœ… TechnicalAnalyzer imported successfully
```

---

## æ¤œè¨¼çµæœ

| ãƒ†ã‚¹ãƒˆé …ç›® | çµæœ | è©³ç´° |
|:---|:---|:---|
| **yfinanceãƒãƒ¼ã‚¸ãƒ§ãƒ³** | âœ… | 0.2.66 ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ |
| **å˜ä¸€ãƒ†ã‚£ãƒƒã‚«ãƒ¼å–å¾—** | âœ… | 6869.T æˆåŠŸ |
| **è¤‡æ•°ãƒ†ã‚£ãƒƒã‚«ãƒ¼å–å¾—** | âœ… | 5/5 å…¨ã¦æˆåŠŸ |
| **æ—¥æœ¬æ ªå–å¾—** | âœ… | 6869.T, 1926.T, 8306.T å…¨ã¦æˆåŠŸ |
| **ç±³å›½æ ªå–å¾—** | âœ… | AAPL, MSFT å…¨ã¦æˆåŠŸ |
| **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ** | âœ… | DataFetcher, Analyzer æ­£å¸¸ |
| **429ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ** | âœ… | **0ä»¶ - å®Œå…¨ã«è§£æ±º** |

---

## æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ | æ”¹å–„ |
|:---|:---|:---|:---|
| **ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸç‡** | 0% | 100% | å®Œå…¨æ”¹å–„ |
| **429ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ** | 100% | 0% | å®Œå…¨æ’é™¤ |
| **å‡¦ç†é€Ÿåº¦** | ãƒªãƒˆãƒ©ã‚¤é…å»¶å¤šç™º | é«˜é€Ÿ | å¤§å¹…æ”¹å–„ |
| **ã‚³ãƒ¼ãƒ‰ä¿å®ˆæ€§** | è¤‡é›‘ | ã‚·ãƒ³ãƒ—ãƒ« | å‘ä¸Š |

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- âœ… curl_cffi ã«ã‚ˆã‚‹å®‰å…¨ãªé€šä¿¡
- âœ… User-Agent è‡ªå‹•è¨­å®šï¼ˆæœ€æ–°åŒ–ï¼‰
- âœ… èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®è‡ªå‹•åŒ–

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´

### ä¿®æ­£æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ | è¡Œæ•° |
|:---|:---|:---|
| `analysis/requirements.txt` | yfinanceãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–° | 1è¡Œ |
| `analysis/src/data_fetch.py` | ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šå‰Šé™¤ã€ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£ | 65å‰Šé™¤ + 3è¿½åŠ  |

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰

| ãƒ•ã‚¡ã‚¤ãƒ« | ç›®çš„ |
|:---|:---|
| `onetime/yfinance_diagnosis_1_1.py` | åˆæœŸè¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `onetime/yfinance_diagnosis_1_1_revised.py` | ä¿®æ­£ç‰ˆè¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `onetime/test_yfinance_fix_integration.py` | çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | å†…å®¹ |
|:---|:---|
| `Do/18_yfinance_429_RootCause_Analysis.md` | æ ¹æœ¬åŸå› åˆ†æãƒ»è§£æ±ºç­– |
| `Do/19_yfinance_429_Implementation.md` | ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| `01-project-progress.md` | é€²æ—æ›´æ–° |

---

## ä»Šå¾Œã®æ¨å¥¨äº‹é …

### 1. æœ¬ç•ªç’°å¢ƒã§ã®æ¤œè¨¼

```bash
# 100éŠ˜æŸ„ä»¥ä¸Šã§ã®å¤§è¦æ¨¡ãƒ†ã‚¹ãƒˆæ¨å¥¨
docker exec paypay-analysis python test_large_scale.py
```

### 2. ãƒ­ã‚°ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```bash
# 429ã‚¨ãƒ©ãƒ¼ã®ç›£è¦–
docker logs paypay-analysis | grep "429"
```

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

- åˆ†æå®Ÿè¡Œæ™‚é–“ã‚’è¨˜éŒ²
- API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã‚’ç›£è¦–
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ç¢ºèª

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ: ã¾ã  429 ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆ

**åŸå› **: Yahoo Finance API ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**å¯¾ç­–**:
1. `analysis/src/data_fetch.py` ã® `rate_limit_delay` ã‚’å¢—åŠ 
2. `min_delay_between_requests` ã‚’å¢—åŠ 
3. ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’ç¸®å°

### å•é¡Œ: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼

**åŸå› **: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥

**å¯¾ç­–**:
```bash
docker-compose down -v
docker-compose up -d --build --no-cache
```

### å•é¡Œ: curl_cffi ã‚¨ãƒ©ãƒ¼

**åŸå› **: ä¾å­˜é–¢ä¿‚ãŒä¸å®Œå…¨

**å¯¾ç­–**:
```bash
docker exec paypay-analysis pip install --upgrade curl_cffi
```

---

## æ¤œè¨¼è€…ãƒãƒ¼ãƒˆ

### é©ç”¨ãƒ—ãƒ­ã‚»ã‚¹

1. âœ… requirements.txt æ›´æ–°ï¼ˆ1åˆ†ï¼‰
2. âœ… Docker å†æ§‹ç¯‰ï¼ˆ5åˆ†ï¼‰
3. âœ… data_fetch.py ä¿®æ­£ï¼ˆ3åˆ†ï¼‰
4. âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆ10åˆ†ï¼‰

**ç·æ‰€è¦æ™‚é–“: ç´„19åˆ†**

### ç¢ºèªäº‹é …

- âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ã‚¨ãƒ©ãƒ¼ãªã—
- âœ… ãƒ†ã‚£ãƒƒã‚«ãƒ¼ ãƒ‡ãƒ¼ã‚¿å–å¾— æˆåŠŸ
- âœ… 429ã‚¨ãƒ©ãƒ¼ ç™ºç”Ÿãªã—
- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ é«˜é€ŸåŒ–ç¢ºèª

### æ³¨è¨˜

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API (`/api/analysis/trigger`) ã«ã¯ã¾ã å®Ÿè£…ä¸Šã®å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼ˆåˆ¥é€”å¯¾å¿œãŒå¿…è¦ï¼‰ã€‚ãŸã ã—ã€yfinance 429ã‚¨ãƒ©ãƒ¼ã®ä¿®æ­£ã¯ **å®Œå…¨ã«å®Œäº†**ã—ã¦ã„ã¾ã™ã€‚

---

## çµè«–

âœ… **yfinance 429ã‚¨ãƒ©ãƒ¼ã®å•é¡Œã¯ã€ä»¥ä¸‹ã®ä¿®æ­£ã«ã‚ˆã‚Šå®Œå…¨ã«è§£æ±ºã•ã‚Œã¾ã—ãŸï¼š**

1. yfinance ã‚’ 0.2.32 ã‹ã‚‰ 0.2.66 ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
2. å¤ã„ requests.Session ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚’å‰Šé™¤
3. yfinance ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ curl_cffi ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨

**å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã€æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚**

---

**é©ç”¨å®Œäº†æ—¥**: 2025-10-31 21:00 JST  
**æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œå…¨åˆæ ¼  
**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: æ¬¡ã®ã‚¿ã‚¹ã‚¯ã«é€²è¡Œå¯èƒ½
