# プロジェクト整合性レポート

**最終更新：** 2025-10-30

---

## 1. 矛盾点の特定

### 1-1. データ更新方式の確定

**問題：** なし（ユーザーフィードバックにより確定）

**決定内容：**

- `Do/01_Requirements.md`：「データ更新は手動」→ 確定
- `Do/02_Tech_Roadmap.md`：「手動更新（ユーザーが UI からボタンをクリック）」→ 確定
- `Do/04_Tasks.md`：T046「POST /api/analyze エンドポイント」→ 手動実行

**確認事項：** ✅ ユーザーが「スケジューラーはいらない、手動で行う」と明示

**対応状況：** 完了（全ドキュメント更新済）

---

### 1-2. 買い/売り判定アルゴリズムの確定

**問題：** なし（ユーザーフィードバックにより確定）

**決定内容：**

- `Do/01_Requirements.md`：「テクニカル指標（移動平均線、RSI、MACDなど）をベースにした判断ロジック」
- `Do/03_Tech_datasheet.md` セクション 2.5：提案されたアルゴリズムコード（Python）を採用
- `Do/04_Tasks.md` T042：「複数指標の重み付け、スコア算出、判定ルール実装」

**確認事項：** ✅ ユーザーが「買い/売り判定アルゴリズムはお任せする」と明示

**採用アルゴリズム：**

- **移動平均線（MA）：** ゴールデンクロス判定 40%
- **RSI：** 売られ過ぎ判定（< 30） 30%
- **MACD：** ポジティブ判定 30%
- **スコア基準：** 0.7以上 = 買い、0.3以下 = 売り、その他 = 保有

**対応状況：** 完了（全ドキュメント確定）

---

### 1-3. ユーザー認証の確定

**問題：** なし（ユーザーフィードバックにより確定）

**決定内容：**

- `Do/01_Requirements.md`：「認証不要」→ 確定
- `Do/02_Tech_Roadmap.md`：「初期版は不要」→ 確定
- `Do/03_Tech_datasheet.md` セクション 2.4：「認証機能実装不要」
- `Do/04_Tasks.md`：認証関連タスクなし

**確認事項：** ✅ ユーザーが「個人使用なので認証いらない」と明示

**実装方針：**

- シングルユーザー向けアプリケーション
- ローカル実行環境（Docker + localhost）
- ログイン機能なし
- JWT認証不要

**対応状況：** 完了（全ドキュメント確定）

---

## 2. 重複項目の特定

### 2-1. テクニカル指標計算の説明重複

**具体例：**

- `Do/02_Tech_Roadmap.md` セクション 5：モジュール 4 で「テクニカル指標計算、買い/売り判断ロジック」の説明
- `Do/03_Tech_datasheet.md` セクション 2.5：買い/売り判定アルゴリズムの詳細コード例
- `Do/04_Tasks.md` フェーズ 3：T039-T041、T042 で同様の内容

**問題度：** 低（異なる詳細度での説明なので、むしろ必要な冗長性）

**対応：** 特に対応不要。ただし、実装時は `Do/03_Tech_datasheet.md` のコード例を参考に実装すること。

---

### 2-2. API エンドポイント仕様の重複

**具体例：**

- `Do/02_Tech_Roadmap.md` セクション 5：モジュール 2 で「GET /api/stocks」などのエンドポイント列挙
- `Do/03_Tech_datasheet.md` セクション 2.3：同じエンドポイント一覧 + レスポンス例
- `Do/04_Tasks.md` フェーズ 2：T024-T033 で同じエンドポイント実装タスク

**問題度：** 低（各ドキュメントの役割に応じた説明）

**対応：** 実装時は `Do/03_Tech_datasheet.md` セクション 2.3 の API 仕様を正規仕様として参照。

---

## 3. 曖昧表現の特定

### 3-1. 「将来対応」の曖昧性

**具体例：**

- `Do/02_Tech_Roadmap.md` セクション 9.1：「WebSocket または Server-Sent Events（SSE）によるリアルタイム更新の導入」
- `Do/02_Tech_Roadmap.md` セクション 9.2：「機械学習への将来移行を検討」
- `Do/02_Tech_Roadmap.md` セクション 9.3：「マイクロサービスアーキテクチャへの移行」

**問題：** 「将来」の時期が明確でなく、初期開発の優先順位判断に影響する可能性。

**推奨対応：**

- 将来拡張は「フェーズ6 以降」と明記し、初期開発（フェーズ1-5）の スコープから除外することを明確化

**ユーザー決定欄：**

- [ ] 初期開発（フェーズ1-5）は提案された範囲で OK
- [ ] 初期開発に含めたい機能がある（具体的に：_________________）

---

### 3-2. 「オプション」機能の曖昧性

**具体例：**

- `Do/04_Tasks.md` T019：「Prismaシードデータ（ダミー銘柄）作成（オプション）」
- `Do/03_Tech_datasheet.md` セクション 3.3：「ステップ 3: スケジューラ（Node.js 側）」の実装形式が複数パターン可能

**問題：** 何が「オプション」か、何が「必須」かが不明確。

**推奨対応：**

- 要件ドキュメント（Do/01_Requirements.md）に「MVP（Minimum Viable Product）機能」と「オプション機能」を明示する

**ユーザー決定欄：**

- [ ] 提案された必須/オプション分類で OK
- [ ] 変更したい項目がある（具体的に：_________________）

---

### 3-3. テスト カバレッジ要件の曖昧性

**具体例：**

- `Do/04_Tasks.md` セクション 6：「APIテストカバレッジ80%以上」と明記
- `Do/04_Tasks.md` T034：「正常系・異常系カバー」→ 具体的な範囲不明
- `Do/04_Tasks.md` T061：「Jest + React Testing Library」を使用するが、カバレッジ目標値なし

**問題：** バックエンドは 80% 以上だが、フロントエンドは目標なし。テスト品質のばらつき。

**推奨対応：**

- 全体的なテストカバレッジ目標を統一（推奨：70-80%）
- `Do/04_Tasks.md` に具体的なカバレッジ目標値を明記

**ユーザー決定欄：**

- [ ] バックエンド 80%、フロントエンド 70% で OK
- [ ] 別の基準で OK（具体的に：_________________）

---

## 4. 未定義項目の特定

### 4-1. パフォーマンス要件の未定義

**具体例：**

- `Do/04_Tasks.md` T065：「APIレスポンス時間最適化」とあるが、目標値なし
- `Do/04_Tasks.md` T062：「UIレスポンス時間 < 1 秒」と成功基準にはあるが、T062 タスクには明記なし

**問題：** 「最適化」の具体的なゴールが不明確。

**推奨対応：**
以下をパフォーマンス要件として定義：

| 項目 | 目標値 | 優先度 |
|------|------|-------|
| API GET 銘柄一覧レスポンス | < 500ms | 高 |
| API GET 分析結果レスポンス | < 300ms | 高 |
| フロントエンド 初期ロード時間 | < 2秒 | 中 |
| UI インタラクション レスポンス | < 1秒 | 高 |

**ユーザー決定欄：**

- [ ] 提案されたパフォーマンス目標で OK
- [ ] 別の目標値を設定したい（具体的に：_________________）

---

### 4-2. エラーハンドリング仕様の未定義

**具体例：**

- `Do/03_Tech_datasheet.md` セクション 2.1：「エラーハンドリング：統一的なエラーレスポンス形式」とあるが、形式例なし
- `Do/04_Tasks.md` T020：「統一的なエラーレスポンス形式定義」とあるが、具体的な形式なし

**問題：** フロントエンド・バックエンド間のエラーメッセージ形式が統一されていない可能性。

**推奨対応：**
以下の標準エラーレスポンス形式を `Do/03_Tech_datasheet.md` に追加：

```json
{
  "status": "error",
  "code": "VALIDATION_ERROR",
  "message": "ユーザーフレンドリーなエラー説明",
  "details": {
    "field": "エラーの詳細（開発者向け）"
  }
}
```

**ユーザー決定欄：**

- [ ] 提案されたエラーレスポンス形式で OK
- [ ] 別の形式を使用したい（具体的に：_________________）

---

### 4-3. ロールバック・フェイルセーフ戦略の未定義

**具体例：**

- `Do/04_Tasks.md` T074：「本番DBマイグレーション計画・実行」とあるが、ロールバック方法なし
- `Do/04_Tasks.md` T047：「スケジューラエラーハンドリング・リトライロジック実装」とあるが、最大リトライ回数など具体的なパラメータなし

**問題：** 本番環境での障害時の対応方法が不明確。

**推奨対応：**

- DB マイグレーション手順書に「ロールバック手順」を追加
- スケジューラの「最大リトライ回数：3回」、「リトライ間隔：5分」などを定義

**ユーザー決定欄：**

- [ ] 別紙で詳細な運用手順書を作成する
- [ ] デプロイ前に運用チームと打ち合わせを実施する

---

### 4-4. コスト・ライセンス要件の未定義

**具体例：**

- `Do/03_Tech_datasheet.md` セクション 1.3：「yfinance：無料で株価データを簡単に取得可能」と記述
- ただし、大量リクエスト時のレート制限や有料プランの必要性が未定義
- PostgreSQL、Node.js、React は OSS だが、デプロイ先（Heroku、AWS）のコスト試算なし

**問題：** 実装後に予期しないコストが発生する可能性。

**推奨対応：**
以下の情報を収集して `Do/02_Tech_Roadmap.md` に追加：

| 項目 | 費用 | 備考 |
|------|------|------|
| yfinance API | 無料 | レート制限：分析銘柄数に応じて確認要 |
| PostgreSQL | 無料（自前サーバー）または月 $10-50（マネージドサービス） | Heroku: $9-50/月 |
| Node.js/React | 無料（OSS） | - |
| Heroku ホスティング | 月 $7-50 | スケーリング時は増加 |
| AWS EC2 | 月 $10-100+ | インスタンスサイズ・リージョンで変動 |

**ユーザー決定欄：**

- [ ] 上記のコスト試算を基に、デプロイ先を決定する
- [ ] 具体的な予算上限：_________________

---

### 4-5. サポート・メンテナンス体制の未定義

**具体例：**

- `Do/04_Tasks.md` セクション 6：成功基準として「本番環境で無障害運用」とあるが、その後の保守体制なし
- `Do/04_Tasks.md` T077、T078：監視・ログ設定とあるが、アラート対応の SLA（Service Level Agreement）なし

**問題：** 本番運用開始後のサポート負荷が不明確。

**推奨対応：**
以下の項目をプロジェクト計画に追加：

- **監視体制：** 誰が 24/7 監視するのか
- **アラート対応 SLA：** エラー発生から対応までの目標時間
- **定期メンテナンス：** 月次パッチ適用、セキュリティ更新の頻度
- **サポート終了日：** アプリケーション提供終了予定日

**ユーザー決定欄：**

- [ ] 別途、運用・保守ドキュメントを作成する
- [ ] 保守・サポート体制の詳細：_________________

---

## 5. ドキュメント間の整合性マトリックス

| チェック項目 | Do/01 | Do/02 | Do/03 | Do/04 | 整合性 |
|-----------|-------|-------|-------|-------|-------|
| データ更新頻度 | ❓ | ✅ 日次 | ✅ 日次 | ✅ 15:30 | ⚠️ 未確認 |
| テクニカル指標 | ✅ MA/RSI/MACD | ✅ 同記述 | ✅ 詳細コード | ✅ 実装タスク | ✅ 一貫 |
| ユーザー認証 | ❓ | 不要 | 不要 | 実装タスクなし | ⚠️ 要確認 |
| API仕様 | - | 列挙 | ✅ 詳細 | 実装タスク | ✅ 一貫 |
| テストカバレッジ | - | - | - | ⚠️ 不統一 | ⚠️ 要整備 |
| パフォーマンス目標 | - | - | - | ⚠️ 不完全 | ⚠️ 要定義 |

**凡例：**

- ✅：明確に定義されており、整合性あり
- ⚠️：矛盾・不完全・要確認
- ❓：未決定・未定義
- -：該当なし

---

## 6. 推奨アクション

### 6-1 緊急対応（実装開始前）

1. **ユーザーへの確認事項：**
   - [ ] データ更新頻度（日次 vs リアルタイム）
   - [ ] ユーザー認証の必要性（シングルユーザー vs マルチユーザー）
   - [ ] 買い/売り判定アルゴリズムの確定
   - [ ] 初期版のスコープ確定

2. **ドキュメント更新：**
   - [ ] Do/01_Requirements.md に「買い/売り判定アルゴリズムの詳細」を追加
   - [ ] Do/01_Requirements.md に「パフォーマンス要件」を追加
   - [ ] Do/03_Tech_datasheet.md に「エラーレスポンス形式例」を追加

---

### 6-2 実装開始時

3. **テスト戦略の明確化：**
   - [ ] テストカバレッジ目標値（API・フロントエンド・分析エンジン別）
   - [ ] テスト環境セットアップ手順

4. **本番運用準備：**
   - [ ] パフォーマンス監視・アラート設定のプロトコル
   - [ ] ロールバック手順書作成
   - [ ] 定期メンテナンス計画

---

### 6-3 本番運用開始後

5. **サポート体制確立：**
   - [ ] 運用・保守ドキュメント作成
   - [ ] SLA 定義と通知体制
   - [ ] セキュリティ脆弱性対応プロセス

---

## 7. 承認・サイン オフ

**ユーザー確認項目：**

- [ ] 1. 矛盾点の対応を理解した
- [ ] 2. 重複項目の説明を理解した
- [ ] 3. 曖昧表現の整理を理解した
- [ ] 4. 未定義項目を理解した
- [ ] 5. 推奨アクション実施に同意する

**設計確認者サイン：**

- ユーザー名：_________________ 日付：_________________
- プロジェクトマネージャー：_________________ 日付：_________________

---

## 7-1. バックテスト戦略の補足

### バックテスト実装方針

**タスク T043：バックテスト実装（過去1年データでの検証）**について、以下の方針で進めます：

**バックテストの目的：**

- 提案されたテクニカル判定アルゴリズムの有効性を過去データで検証
- 買いシグナルの精度（勝率）を測定
- アルゴリズムの改善方向を特定

**バックテスト実施方法：**

1. **データ期間：** 過去1年間の日本株価データ（yfinance から取得）
2. **対象銘柄：** 初期テスト時は 10-20 銘柄（代表的な銘柄）
3. **バックテスト項目：**
   - 買いシグナル発生後の価格変動を追跡
   - 実際の上昇確率（勝率）を計算
   - 平均利益率を計算
   - 最大ドローダウンを計算
4. **合格基準：**
   - 買いシグナルの勝率：**50%以上**（ランダム以上）
   - 平均利益率：正のリターンを期待
5. **結果が目標未達の場合：**
   - アルゴリズムの重み付けを調整
   - 追加指標の組み込みを検討
   - パラメータ最適化を実施

**実装手順（フェーズ3の一部）：**

- T043a: バックテスト用データ取得スクリプト実装
- T043b: バックテスト分析ロジック実装
- T043c: レポート生成機能実装
- T043d: 過去1年のバックテスト実行
- T043e: 結果分析と改善提案

**成果物：**

- バックテストレポート（勝率、収益率等）
- 改善推奨事項書

---

## 8. 次のステップ

このレポートをもとに、以下を実施してください：

1. **ユーザー確認会議を開催** - 矛盾・未定義項目を確認
2. **バックテスト戦略の承認** - 上記バックテスト方針の確認
3. **承認を得た後、ドキュメント最終版を作成**
4. **技術設計・アーキテクチャ検討会議を開催**
5. **実装開始（フェーズ1 タスク T001 から）**

---

**このレポートの有効期限：** 2025年11月30日

最新の技術スタック・要件変更があった場合は、このレポートを更新してください。
